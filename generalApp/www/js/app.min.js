/*
Ionic Tutorial by @ekussberg:

* https://github.com/ekussberg
* https://twitter.com/ekussberg
* https://www.facebook.com/edgarkussberg

Full source at https://github.com/shprink/gulp-examples

MIT License, https://github.com/shprink/gulp-examples/blob/master/LICENSE
*/
angular.module("ioneazly",["ionic","ngCordova","StorageService"]).constant("AUTH_EVENTS",{notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{admin:"admin_role","public":"public_role"}).run(["$ionicPlatform","$rootScope","$state","AuthService","AUTH_EVENTS",function(t,e,o,n,i){t.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0))}),e.$on("$stateChangeStart",function(t,r,a,s){if("data"in r&&"authorizedRoles"in r.data){var l=r.data.authorizedRoles;n.isAuthorized(l)||(t.preventDefault(),o.go(o.current,{},{reload:!0}),e.$broadcast(i.notAuthorized))}n.isAuthenticated||"login"!==r.name&&(t.preventDefault(),o.go("login"))})}]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("app",{url:"","abstract":!0,templateUrl:"templates/menu.html",controller:"UserCtrl"}).state("login",{url:"/login",templateUrl:"templates/login.html",controller:"UserCtrl"}).state("app.main",{url:"/main",views:{menuContent:{templateUrl:"templates/main.html"}}}).state("app.todo",{url:"/todo",views:{menuContent:{templateUrl:"templates/todo-list.html",controller:"TodoListCtrl"}}}).state("app.todo.single",{url:"/:todoId",views:{"menuContent@app":{templateUrl:"templates/todo-single.html",controller:"TodoSingleCtrl"}}}).state("app.barcodescanner",{url:"/barcodescanner",views:{menuContent:{templateUrl:"templates/barcodeScanner.html",controller:"BarcodeScannerCtrl as ctrl"}}}),e.otherwise("/main")}]);var BarcodeScannerCtrl=function(){function t(t,e,o,n,i){this.$scope=t,this.$ionicSideMenuDelegate=e,this.$ionicLoading=o,this.$cordovaBarcodeScanner=n,this.$cordovaDialogs=i,this.scannedCode="",this.currentlyScanning=!1,this.toggleLeft=function(){this.$ionicSideMenuDelegate.toggleLeft()},this.scanCode=function(){return this.$ionicLoading.show({template:"<ion-spinner></ion-spinner>"}),this.currentlyScanning===!0?void this.$ionicLoading.hide():-1!==ionic.Platform.platforms.indexOf("browser")?(this.$ionicLoading.hide(),void(this.scannedCode="QR Code scanner not available in development browser.")):(this.currentlyScanning=!0,void this.$cordovaBarcodeScanner.scan().then(function(t){this.$ionicLoading.hide(),this.currentlyScanning=!1,this.scannedCode=t.text},function(t){this.$ionicLoading.hide(),this.currentlyScanning=!1,this.$cordovaDialogs.alert(t,"barcode Error","OK")}))}}return t.$inject=["$scope","$ionicSideMenuDelegate","$ionicLoading","$cordovaBarcodeScanner","$cordovaDialogs"],t}();angular.module("ioneazly").controller("BarcodeScannerCtrl",BarcodeScannerCtrl);var TodoListCtrl=function(){function t(t,e,o,n,i){this.$scope=t,this.$state=e,this.$ionicSideMenuDelegate=o,this.$ionicModal=n,this.TodoService=i,t.showDeleteButtons=!1,t.todos=[],t.$on("$ionicView.beforeEnter",function(){t.todos=i.getAll()}),t.toggleLeft=function(){o.toggleLeft()},t.toggleRemoveItems=function(){t.showDeleteButtons?t.showDeleteButtons=!1:t.showDeleteButtons=!0},n.fromTemplateUrl("partials/new-todo.html",function(e){t.todoModal=e},{scope:t,animation:"slide-in-up"}),t.addTodo=function(){t.todoModal.show()},t.closeNewTodo=function(){t.todoModal.hide()},t.createTodo=function(e){i.add(e),t.todos=i.getAll(),t.todoModal.hide(),e.title=""},t.removeTodo=function(e){i.removeById(e),t.todos=i.getAll()},t.showSingleTodo=function(t){e.go("app.todo.single",{todoId:t})}}return t.$inject=["$scope","$state","$ionicSideMenuDelegate","$ionicModal","TodoService"],t}();angular.module("ioneazly").controller("TodoListCtrl",TodoListCtrl);var TodoSingleCtrl=function(){function t(t,e,o,n){this.$stateParams=t,this.$scope=e,this.$ionicHistory=o,this.TodoService=n,e.goBack=function(){o.goBack()},e.todo=n.findById(parseInt(t.todoId)),e.todo.dueDate&&(e.todo.dueDate=new Date(e.todo.dueDate)),e.saveTodo=function(){n.updateById(e.todo.id,e.todo),o.goBack()}}return t.$inject=["$stateParams","$scope","$ionicHistory","TodoService"],t}();angular.module("ioneazly").controller("TodoSingleCtrl",TodoSingleCtrl);var UserCtrl=function(){function t(t,e,o,n){t.doLogin=function(t){n.login(t.username,t.password).then(function(o){t.username="",t.password="",e.go("app.main",{},{reload:!0})},function(t){o.alert({title:"Login failed!",template:"Please check your credentials!"})})},t.doLogout=function(){n.logout(),e.go("login")}}return t.$inject=["$scope","$state","$ionicPopup","AuthService"],t}();angular.module("ioneazly").controller("UserCtrl",UserCtrl);var AuthService=function(){function t(t,e,o){this.$q=t,this.$http=e,this.USER_ROLES=o,this.LOCAL_TOKEN_KEY="authKey",this.username="",this.isAuthenticated=!1,this.role="",this.loadUserCredentials=function(){var t=window.localStorage.getItem(this.LOCAL_TOKEN_KEY);t&&this.useCredentials(t)},this.storeUserCredentials=function(t){window.localStorage.setItem(this.LOCAL_TOKEN_KEY,t),this.useCredentials(t)},this.useCredentials=function(t){this.username=t.split(".")[0],this.isAuthenticated=!0,this.authToken=t,"admin"==this.username&&(this.role=o.admin),"user"==this.username&&(this.role=o["public"]),e.defaults.headers.common["X-Auth-Token"]=t},this.destroyUserCredentials=function(){this.authToken=void 0,this.username="",this.isAuthenticated=!1,e.defaults.headers.common["X-Auth-Token"]=void 0,window.localStorage.removeItem(this.LOCAL_TOKEN_KEY)},this.login=function(e,o){var n=this;return t(function(t,i){"admin"==e&&"1"==o||"user"==e&&"1"==o?(n.storeUserCredentials(e+".yourServerToken"),t("Login success.")):i("Login Failed.")})},this.logout=function(){this.destroyUserCredentials()},this.isAuthorized=function(t){return angular.isArray(t)||(t=[t]),this.isAuthenticated&&-1!==t.indexOf(role)},this.loadUserCredentials()}return t.$inject=["$q","$http","USER_ROLES"],t}();angular.module("ioneazly").service("AuthService",AuthService).factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS",function(t,e,o){return{responseError:function(n){return t.$broadcast({401:o.notAuthenticated,403:o.notAuthorized}[n.status],n),e.reject(n)}}}]).config(["$httpProvider",function(t){t.interceptors.push("AuthInterceptor")}]);var LocalStorage=function(){function t(){this.set=function(t,e){window.localStorage[t]=e},this.get=function(t,e){return window.localStorage[t]||e},this.setObject=function(t,e){window.localStorage[t]=JSON.stringify(e)},this.getObject=function(t){return JSON.parse(window.localStorage[t]||"{}")}}return t}();angular.module("StorageService",[]).service("$localStorage",LocalStorage);var TodoService=function(){function t(t){this.$localStorage=t,this.defaultTodos=[],this.getAll=function(){var e=t.getObject("todos");return e instanceof Array||(e=this.defaultTodos,t.setObject("todos",this.defaultTodos)),e},this.removeById=function(e){for(var o=t.getObject("todos"),n=0;n<o.length;n++)if(o[n].id===e){o.splice(n,1),t.setObject("todos",o);break}},this.findById=function(e){for(var o=t.getObject("todos"),n=0;n<o.length;n++)if(o[n].id===e)return o[n];return null},this.add=function(e){var o=t.getObject("todos");o||(o=[]),e.id=o.length,o.unshift(e),t.setObject("todos",o)},this.updateById=function(e,o){for(var n=t.getObject("todos"),i=0;i<n.length;i++)if(n[i].id===e){n[i]=o;break}t.setObject("todos",n)},this.defaultTodos=[{id:0,title:"Ben Sparrow",lastText:"You on your way?",face:"img/ben.png"},{id:1,title:"Max Lynx",lastText:"Hey, it's me",face:"img/max.png"},{id:2,title:"Adam Bradleyson",lastText:"I should buy a boat",face:"img/adam.jpg"},{id:3,title:"Perry Governor",lastText:"Look at my mukluks!",face:"img/perry.png"},{id:4,title:"Mike Harrington",lastText:"This is wicked good ice cream.",face:"img/mike.png"}]}return t.$inject=["$localStorage"],t}();angular.module("ioneazly").service("TodoService",TodoService);